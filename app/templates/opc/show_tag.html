{% extends "base.html" %}
{% block title %}alarm{% endblock %}
{% block head %}
<style type="text/css">

</style>
{% endblock %}
{% block content %}
<div class="row">
    <div class="col-12">
        <!-- 标题 、功能表单 -->
        <nav class="navbar justify-content-between" style="background-color: #058dee;">

            <a class="navbar-brand">
                <img src="/static/pic/bootstrap-solid.svg" width="30" height="30" class="d-inline align-middle" alt="">
                alarm
            </a>

            <span class="navbar-text">
                Navbar text with an inline element
            </span>
            <form action="{{request.path}}" method="get" class="form-inline my-2 my-lg-0 needs-validation" novalidate>
                <div class="form-group">
                    <select class=" custom-select" name='module' id="module" required>
                        <option>s_opcda_client1</option>
                        <option>s_opcda_client2</option>
                        <option>s_opcda_client3</option>
                        <option>modbus1</option>
                        <option>modbus2</option>
                    </select>
                </div>
                <button class="btn btn-warning  my-2 my-sm-0" type="submit">点击 查询</button>
            </form>
        </nav>

        <hr class="border-bottom border-danger" />

    </div>

    <!-- 分组表 -->
    <div class="col-12 text-center">
        <table class="table table-bordered table-hover">
            <thead>
                <tr>
                    <th>group_id</th>
                    <th>group_name</th>
                    <th>collect_cycle</th>
                    <th>tags_num</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id='alarm'>
                {% for gi in group_infos %}
                <tr>
                    <td> {{gi['group_id']}}</td>
                    <td> {{gi['group_name']}}</td>
                    <td> {{gi['collect_cycle']}}</td>
                    <td> {{gi['tags_num']}}</td>
                    <td>
                        <!-- <a class="btn btn-info btn-sm" href="{{url_for('cs.page1',group_id=gi['group_id'])}}">编辑</a> -->
                        <a id="showLogModel1" href="javascript:void(0)" onclick="showLogModel('{{gi['group_id']}}')">查看

                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
<!-- 分页 -->
<div class="row mt-4 ">
    <div class="col-md-12 col-sm-12 ">
        <nav>
            <ul class="pagination pagination-md justify-content-end">
                <ul class="pagination  justify-content-end" id='page'>
                    <li class="page-item ">
                        {% if paginate.has_prev %}
                        <a class="page-link form-control" tabindex="-1"
                            href="/page1?page={{ paginate.prev_num }}">Previous</a>
                        {% endif %}
                    </li>


                    {%  for i in  paginate.iter_pages %}

                    {% if i %}
                    {%if paginate.page == i%}
                    <li class="page-item active">
                        <a class="page-link form-control" href="/page1?page={{ i }}">{{ i }}</a>
                    </li>
                    {%else%}
                    <li class="page-item ">
                        <a class="page-link form-control" href="/page1?page={{ i }}">{{ i }}</a>
                    </li>
                    {% endif %}
                    {% else %}
                    <li class="page-item ">
                        <a class="page-link form-control" href="/page1?page={{ i }}">...</a>
                    </li>

                    {% endif %}

                    {% endfor %}

                    {% if paginate.has_next %}
                    <a class="page-link form-control" href="/page1?page={{ paginate.next_num }}">Next</a>
                    {% endif %}

                    </li>
                </ul>

                <li class="page-item"><a class="page-link form-control">共</a></li>
                <input id='total' name='total' disabled class="form-control" style="width: 60px;"
                    value="{{ paginate.total }}" />
                <li class="page-item"><a class="page-link form-control">条</a></li>
                <li class="page-item"><a class="page-link form-control">共</a></li>
                <input id='max_pages' name='max_pages' disable class="form-control" style="width: 60px;"
                    value="{{ paginate.pages }}" />
                <li class="page-item"><a class="page-link form-control">页</a></li>
            </ul>
        </nav>
    </div>
</div>

<!--tag展示-->
<div class="modal fade" id="LogModel" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog  modal-sm modal-dialog-centered" style="max-width:1000px;">
        <div class="modal-content">
            <div class="modal-header">

                <button class="btn btn-outline-success my-2 my-sm-0" type="submit">新建位号</button>
                <form class="form-inline my-2 my-lg-0">
                    <input class="form-control mr-sm-2" type="search" placeholder="Search" aria-label="Search">
                    <button class="btn btn-outline-success my-2 my-sm-0" type="submit">查询位号</button>
                </form>
            </div>
            <div class="modal-body">


                <table class="table  table-bordered">
                    <thead id='keys'>

                    </thead>
                    <tbody id='values'>

                    </tbody>
                </table>

                <div class="row mt-1 ">
                    <div class="col-md-12 col-sm-12 ">
                        <nav id='tag_page'>

                        </nav>
                    </div>
                </div>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-success" onclick="hideLogModel()">
                    关闭
                </button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal -->
</div>
<script>
    var csrftoken = $("meta[name=csrf-token]").attr("content");

    //显示日志模态框
    function showLogModel(group_id) {
        $('#LogModel').modal("show");
        page(group_id);

    }

    function hideLogModel() {
        $('#LogModel').modal("hide");
    }

    function page(group_id) {
        var module_name = $("#module").val()
        $.ajax({
            url: "{{url_for('cs.page1')}}",
            data: {
                "module": module_name,
                "group_id": group_id,
            },
            headers: {
                "X-CSRFToken": csrftoken
            },
            type: 'post',
            dataType: 'json',
            success: pages_success,
            error: function (data) {
                console.log(data);
            },
        });
        return false
    }

    function pages_success(data) {
        var $keys = '';
        var $values = '';
        var $lis = '';
        var $lis1 = '';
        console.log(data.paginate)
        var tags = data.paginate.items
        if (data.paginate.total > 0) {
            for (i in tags) {
                var $keys_td = ''
                var $values_td = ''
                for (t in tags[i]) {
                    $keys_td += '<th scope="row" class="table-info">' + t + '</th>'
                    $values_td += '<td scope="row" class="table-danger">' + tags[i][t] + '</td>'
                };
                $keys = '<tr>' + $keys_td + '</tr>'
                $values += '<tr>' + $values_td + '</tr>'
                var $subject_keys = $('#keys');
                var $subject_values = $('#values');
                $subject_keys.html($keys)
                $subject_values.html($values)
            };
            var lis = ''
            data.paginate.iter_pages.forEach((intem, index) => {
                       var tmp=''
                       if(data.paginate.page==index+1){
                        tmp=`<li class="page-item active "><a class="page-link form-control" href="/page1?page=${index+1} "> ${index+1} </a></li>`
                       }
                       else{
                       tmp= `<li class="page-item "><a class="page-link form-control" href="/page1?page=${index+1} "> ${index+1} </a></li>`
                       }
                       lis+=tmp
            });
            var tag_page =

                `<ul class="pagination pagination-md justify-content-end">
                <li class="page-item ">
                ${ data.paginate.has_prev ?
                `<a class="page-link form-control" tabindex="-1"
                        href="/page1?page=${data.paginate.prev_num} ">Previous</a>`: ''}
                </li>
                ${lis}
                <li class="page-item ">
                ${ data.paginate.has_next ?
                    `<a class="page-link form-control" tabindex="-1"
                        href="/page1?page= ${data.paginate.next_num} ">Next</a>` : ''}
                </li>
                <li class="page-item"><a class="page-link form-control">共</a></li>
                <input id='total' name='total' disabled class="form-control" style="width: 60px;"
                    value=${ data.paginate.total } />
                <li class="page-item"><a class="page-link form-control">条</a></li>
                <li class="page-item"><a class="page-link form-control">共</a></li>
                <input id='max_pages' name='max_pages' disable class="form-control" style="width: 60px;"
                    value=${ data.paginate.pages } />
                <li class="page-item"><a class="page-link form-control">页</a></li>`;

            var $tag_page = $('#tag_page');
            $tag_page.html(tag_page);
        } else {
            $values += '<tr>' + '<td scope="row" class="table-danger">' + '没有位号信息，请重新上传。。。' + '</td>' + '</tr>';
            var $subject_con = $('#values');
            $subject_con.html($values);
        }
    }


    // var int = self.setInterval("page11()", 5000);

    (function () {
        'use strict'

        window.addEventListener('load',
            function () {
                // Fetch all the forms we want to apply custom Bootstrap validation styles to
                var forms = document.getElementsByClassName('needs-validation')

                // Loop over them and prevent submission
                Array.prototype.filter.call(
                    forms,
                    function (form) {
                        form.addEventListener('submit',
                            function (event) {
                                if (form.checkValidity() === false) {
                                    event.preventDefault()
                                    event.stopPropagation()
                                }
                                form.classList.add('was-validated')
                            }, false)
                    })
            }, false)
    }())
</script>
{% endblock %}